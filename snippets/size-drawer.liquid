{%- liquid
  assign drawer_product_form_id = product_form_id
  if drawer_product_form_id == blank
    assign drawer_product_form_id = 'product-form-' | append: section_id
  endif
-%}

<div
  id="size-drawer-{{ section_id }}"
  class="size-drawer"
  data-section-id="{{ section_id }}"
  aria-hidden="true"
>
  <div class="size-drawer__overlay" data-size-drawer-close></div>
  <div
    class="size-drawer__content"
    role="dialog"
    aria-modal="true"
    aria-labelledby="size-drawer-title-{{ section_id }}"
  >
    <header class="size-drawer__header">
      <h3 id="size-drawer-title-{{ section_id }}">Seleciona o tamanho</h3>
      <div class="size-drawer__guide">
        <a href="/pages/guia-de-tamanhos" target="_blank" rel="noopener">
          Guia de tamanhos
        </a>
      </div>
    </header>
    <div class="size-drawer__body">
      <!-- Simple vertical list like collection pages -->
      <div class="size-drawer__list">
        {%- liquid
          assign size_option_index = -1
          for option in product.options_with_values
            assign option_name = option.name | downcase
            if option_name == 'size' or option_name == 'tamanho'
              assign size_option_index = forloop.index0
              assign size_option = option
              break
            endif
          endfor
        -%}

        {%- if size_option_index != -1 and size_option -%}
          {%- for value in size_option.values -%}
            {%- assign variant_available = false -%}
            {%- assign low_stock = false -%}
            {%- assign stock_count = 0 -%}

            {%- for variant in product.variants -%}
              {%- if variant.options[size_option_index] == value -%}
                {%- if variant.available -%}
                  {%- assign variant_available = true -%}
                  {%- assign stock_count = stock_count | plus: variant.inventory_quantity -%}
                  {%- if variant.inventory_quantity <= 3 and variant.inventory_quantity > 0 -%}
                    {%- assign low_stock = true -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}

            <div class="size-item {% unless variant_available %}size-item--unavailable{% endunless %}"
                 data-size="{{ value }}"
                 data-option-index="{{ size_option_index }}">
              <span class="size-item__label">{{ value }}</span>
              {%- if low_stock and variant_available -%}
                <span class="size-item__stock">Poucas unidades</span>
              {%- endif -%}
            </div>
          {%- endfor -%}
        {%- endif -%}
      </div>

      <!-- Calculator Trigger Button -->
      <div class="size-drawer__calculator-trigger">
        <button
          type="button"
          class="size-drawer__calculator-button"
          data-calculator-drawer-trigger="{{ section_id }}"
          aria-controls="size-calculator-drawer-{{ section_id }}"
          aria-haspopup="dialog"
        >
          <svg class="size-drawer__calculator-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="1" width="12" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
            <line x1="4" y1="4" x2="12" y2="4" stroke="currentColor" stroke-width="1.5"/>
            <circle cx="5" cy="7" r="0.75" fill="currentColor"/>
            <circle cx="8" cy="7" r="0.75" fill="currentColor"/>
            <circle cx="11" cy="7" r="0.75" fill="currentColor"/>
            <circle cx="5" cy="10" r="0.75" fill="currentColor"/>
            <circle cx="8" cy="10" r="0.75" fill="currentColor"/>
            <circle cx="11" cy="10" r="0.75" fill="currentColor"/>
            <circle cx="5" cy="13" r="0.75" fill="currentColor"/>
            <circle cx="8" cy="13" r="0.75" fill="currentColor"/>
            <circle cx="11" cy="13" r="0.75" fill="currentColor"/>
          </svg>
          <span>CALCULAR TAMANHO</span>
        </button>
      </div>

      <!-- Status message for feedback -->
      <div id="size-drawer-status-{{ section_id }}" class="size-drawer__status"></div>
    </div>
  </div>
</div>

{%- comment -%} Include Size Calculator Drawer {%- endcomment -%}
{%- render 'size-calculator-drawer', product: product, section_id: section_id -%}

<script>
  window.themeSizeDrawerData = window.themeSizeDrawerData || {};
  window.themeSizeDrawerData['{{ section_id }}'] = {
    productId: {{ product.id }},
    sectionId: '{{ section_id }}',
    productFormId: {{ drawer_product_form_id | json }},
    variants: {{ product.variants | json }},
    options: {{ product.options_with_values | json }},
    colorOptionIndex: -1,
    sizeOptionIndex: -1
  };
</script>
