{% comment %}
  collection-pills.liquid
  Quick product-type pills for collection pages.

  Data source:
    - Preferred: collection.metafields.custom.quick_filter_pills (list)
      * Accepts list of strings or list items with a `label`/`value` property.
    - Fallback: first available product type filter values (if metafield empty).
{% endcomment %}

{%- liquid
  assign product_type_filter = collection.filters | where: 'param_name', 'filter.p.product_type' | first

  assign active_product_type = false
  if product_type_filter and product_type_filter.active_values and product_type_filter.active_values.size > 0
    assign active_product_type = true
  endif

  assign active_other_filters = false
  if collection.filters
    for f in collection.filters
      if f.param_name != 'filter.p.product_type'
        if f.active_values and f.active_values.size > 0
          assign active_other_filters = true
        endif
        if f.type == 'price_range'
          if f.min_value.value != null or f.max_value.value != null
            assign active_other_filters = true
          endif
        endif
      endif
    endfor
  endif

  assign hide_clear_all = false
  if active_product_type and active_other_filters == false
    assign hide_clear_all = true
  endif

  assign raw_pills = nil
  if collection.metafields.custom.quick_filter_pills and collection.metafields.custom.quick_filter_pills.value != blank
    assign raw_pills = collection.metafields.custom.quick_filter_pills.value
  endif

  if raw_pills == nil or raw_pills == empty
    if product_type_filter
      assign raw_pills = product_type_filter.values | map: 'label'
    endif
  endif

  assign pill_joined = ''
  if raw_pills
    for pill in raw_pills
      assign base_label = pill.label | default: pill | strip
      assign base_value = pill.value | default: base_label | strip
      assign parts = base_value | split: ','
      for part in parts
        assign val = part | strip
        if val == ''
          continue
        endif
        if pill_joined == ''
          assign pill_joined = val
        else
          assign pill_joined = pill_joined | append: '||' | append: val
        endif
      endfor
    endfor
  endif

  assign show_pills = false
  if pill_joined != ''
    assign show_pills = true
  endif
  assign pill_items = pill_joined | split: '||'
-%}

{% if show_pills %}
  <style>
    .collection-pills-wrapper {
      margin-bottom: 2rem;
    }
    .collection-pills {
      display: flex;
      gap: 0.625rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .collection-pills__pill {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1.125rem;
      border-radius: 999px;
      border: 1px solid rgba(var(--color-foreground), 0.12);
      background: rgb(var(--color-background));
      color: rgb(var(--color-foreground));
      font-size: 0.875rem;
      font-weight: 500;
      letter-spacing: 0.01em;
      text-decoration: none;
      white-space: nowrap;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .collection-pills__pill:hover {
      border-color: rgba(var(--color-foreground), 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transform: translateY(-1px);
    }
    .collection-pills__pill.is-active {
      background: rgb(var(--color-foreground));
      color: rgb(var(--color-background));
      border-color: rgb(var(--color-foreground));
    }
    .collection-pills__pill.is-active:hover {
      opacity: 0.9;
    }
    @media (max-width: 749px) {
      .collection-pills-wrapper {
        margin-bottom: 1.5rem;
      }
      .collection-pills {
        gap: 0.5rem;
      }
      .collection-pills__pill {
        padding: 0.5rem 0.875rem;
        font-size: 0.8125rem;
      }
    }
    /* Hide built-in active facet chip for product_type so only custom pills show */
    .active-facets__button[data-filter-param="filter.p.product_type"] {
      display: none !important;
    }
  </style>

  {% if hide_clear_all %}
    <style>
      /* Hide clear-all link when the only active filter is product_type (desktop + mobile) */
      .active-facets__button-remove.underlined-link {
        display: none !important;
      }
      .mobile-facets__clear.underlined-link {
        display: none !important;
      }
    </style>
  {% endif %}

  <div class="collection-pills-wrapper page-width">
    <div class="collection-pills" role="list">
      {%- for pill_value in pill_items limit: 12 -%}
      {%- assign pill_label = pill_value -%}

      {%- assign href = collection.url | append: '?filter.p.product_type=' | append: pill_value | url_encode -%}
      {%- assign active = false -%}

      {%- if product_type_filter and product_type_filter.values -%}
        {%- assign match = nil -%}
        {%- for option in product_type_filter.values -%}
          {%- assign option_label_down = option.label | downcase -%}
          {%- assign option_value_down = option.value | downcase -%}
          {%- assign target_down = pill_value | downcase -%}
          {%- if option_label_down == target_down or option_value_down == target_down -%}
            {%- assign match = option -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if match -%}
          {%- assign href = match.url_to_add -%}
          {%- assign active = match.active -%}
          {%- if active -%}
            {%- assign href = match.url_to_remove -%}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}

      <a
        class="collection-pills__pill{% if active %} is-active{% endif %}"
        href="{{ href }}"
        role="listitem"
        aria-pressed="{{ active | default: false }}"
      >
        {{ pill_label | escape }}
      </a>
      {%- endfor -%}
    </div>
  </div>
{% endif %}
