{% comment %}
  collection-pills.liquid
  Unified filter bar: product-type pills + active filter chips.

  Product type pills:
    - Always visible (from metafield or fallback to filter values)
    - Toggleable on/off

  Active filter chips:
    - Shows active filters from OTHER types (color, size, price, etc.)
    - Removable X button
    - Displayed in the same unified bar
{% endcomment %}

{%- liquid
  assign product_type_filter = collection.filters | where: 'param_name', 'filter.p.product_type' | first

  assign has_any_active_filters = false
  if collection.filters
    for f in collection.filters
      if f.active_values and f.active_values.size > 0
        assign has_any_active_filters = true
      endif
      if f.type == 'price_range'
        if f.min_value.value != null or f.max_value.value != null
          assign has_any_active_filters = true
        endif
      endif
    endfor
  endif

  assign raw_pills = nil
  if collection.metafields.custom.quick_filter_pills and collection.metafields.custom.quick_filter_pills.value != blank
    assign raw_pills = collection.metafields.custom.quick_filter_pills.value
  endif

  if raw_pills == nil or raw_pills == empty
    if product_type_filter
      assign raw_pills = product_type_filter.values | map: 'label'
    endif
  endif

  assign pill_joined = ''
  if raw_pills
    for pill in raw_pills
      assign base_label = pill.label | default: pill | strip
      assign base_value = pill.value | default: base_label | strip
      assign parts = base_value | split: ','
      for part in parts
        assign val = part | strip
        if val == ''
          continue
        endif
        if pill_joined == ''
          assign pill_joined = val
        else
          assign pill_joined = pill_joined | append: '||' | append: val
        endif
      endfor
    endfor
  endif

  assign show_pills = false
  if pill_joined != ''
    assign show_pills = true
  endif
  assign pill_items = pill_joined | split: '||'

  assign results_url = collection.url | default: '/collections/all'

  assign show_filter_bar = false
  if show_pills or has_any_active_filters
    assign show_filter_bar = true
  endif
-%}

{% if show_filter_bar %}
  <style>
    /* Unified filter bar container */
    .collection-pills-wrapper {
      margin-top: 1.5rem;
      margin-bottom: 1.75rem;
    }

    /* Main filter bar with pills + chips */
    .collection-pills {
      display: flex;
      gap: 0.625rem;
      align-items: center;
      flex-wrap: wrap;
      padding-left: 25px;
      padding-right: 25px;
    }

    /* Product type pills (always visible) */
    .collection-pills__pill {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1.125rem;
      border-radius: 999px;
      border: 1px solid rgba(var(--color-foreground), 0.12);
      background: rgb(var(--color-background));
      color: rgb(var(--color-foreground));
      font-size: 0.875rem;
      font-weight: 500;
      letter-spacing: 0.01em;
      text-decoration: none;
      white-space: nowrap;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .collection-pills__pill:hover {
      border-color: rgba(var(--color-foreground), 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transform: translateY(-1px);
    }
    .collection-pills__pill.is-active {
      background: rgb(var(--color-foreground));
      color: rgb(var(--color-background));
      border-color: rgb(var(--color-foreground));
    }
    .collection-pills__pill.is-active:hover {
      opacity: 0.9;
    }

    /* Active filter chips (other filters) */
    .collection-pills__chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(var(--color-foreground), 0.2);
      background: rgba(var(--color-foreground), 0.04);
      color: rgb(var(--color-foreground));
      font-size: 0.875rem;
      font-weight: 400;
      text-decoration: none;
      white-space: nowrap;
      transition: all 0.2s ease;
    }
    .collection-pills__chip:hover {
      background: rgba(var(--color-foreground), 0.08);
      border-color: rgba(var(--color-foreground), 0.3);
    }
    .collection-pills__chip-remove {
      display: inline-flex;
      width: 14px;
      height: 14px;
      opacity: 0.6;
    }
    .collection-pills__chip:hover .collection-pills__chip-remove {
      opacity: 1;
    }

    /* Divider between pills and chips */
    .collection-pills__divider {
      width: 1px;
      height: 24px;
      background: rgba(var(--color-foreground), 0.12);
      margin: 0 0.25rem;
    }

    /* Clear all button */
    .collection-pills__clear-all {
      display: inline-flex;
      align-items: center;
      padding: 0.625rem 1rem;
      color: rgb(var(--color-foreground));
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: underline;
      text-underline-offset: 3px;
      white-space: nowrap;
      transition: opacity 0.2s ease;
    }
    .collection-pills__clear-all:hover {
      opacity: 0.7;
    }

    @media (max-width: 749px) {
      .collection-pills-wrapper {
        margin-top: 1.25rem;
        margin-bottom: 1.5rem;
      }
      .collection-pills {
        gap: 0.5rem;
        padding-left: 20px;
        padding-right: 20px;
      }
      .collection-pills__pill,
      .collection-pills__chip {
        padding: 0.5rem 0.875rem;
        font-size: 0.8125rem;
      }
      .collection-pills__divider {
        height: 20px;
      }
    }

    /* Hide all native active filter displays (we show them in unified bar) */
    .active-facets,
    .active-facets-desktop,
    .active-facets-mobile {
      display: none !important;
    }
  </style>

  <div class="collection-pills-wrapper page-width">
    <div class="collection-pills" role="list">
      {%- comment -%} Product type pills (always visible when configured) {%- endcomment -%}
      {%- if show_pills -%}
        {%- for pill_value in pill_items limit: 12 -%}
        {%- assign pill_label = pill_value -%}
        {%- assign href = collection.url | append: '?filter.p.product_type=' | append: pill_value | url_encode -%}
        {%- assign active = false -%}

        {%- if product_type_filter and product_type_filter.values -%}
          {%- assign match = nil -%}
          {%- for option in product_type_filter.values -%}
            {%- assign option_label_down = option.label | downcase -%}
            {%- assign option_value_down = option.value | downcase -%}
            {%- assign target_down = pill_value | downcase -%}
            {%- if option_label_down == target_down or option_value_down == target_down -%}
              {%- assign match = option -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if match -%}
            {%- assign href = match.url_to_add -%}
            {%- assign active = match.active -%}
            {%- if active -%}
              {%- assign href = match.url_to_remove -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}

          <a
            class="collection-pills__pill{% if active %} is-active{% endif %}"
            href="{{ href }}"
            role="listitem"
            aria-pressed="{{ active | default: false }}"
          >
            {{ pill_label | escape }}
          </a>
        {%- endfor -%}
      {%- endif -%}

      {%- comment -%} Divider + Active filter chips from other filter types {%- endcomment -%}
      {%- assign has_other_active = false -%}
      {%- for filter in collection.filters -%}
        {%- if filter.param_name != 'filter.p.product_type' -%}
          {%- if filter.active_values.size > 0 -%}
            {%- assign has_other_active = true -%}
            {%- break -%}
          {%- endif -%}
          {%- if filter.type == 'price_range' -%}
            {%- if filter.min_value.value != null or filter.max_value.value != null -%}
              {%- assign has_other_active = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if has_other_active -%}
        {%- if show_pills -%}
          <div class="collection-pills__divider"></div>
        {%- endif -%}

        {%- for filter in collection.filters -%}
          {%- if filter.param_name != 'filter.p.product_type' -%}
            {%- for value in filter.active_values -%}
              <a href="{{ value.url_to_remove }}" class="collection-pills__chip">
                {{ filter.label | escape }}: {{ value.label | escape }}
                <span class="collection-pills__chip-remove">
                  {{- 'icon-close-small.svg' | inline_asset_content -}}
                </span>
              </a>
            {%- endfor -%}

            {%- if filter.type == 'price_range' -%}
              {%- assign min = filter.min_value.value -%}
              {%- assign max = filter.max_value.value -%}
              {%- if min != null or max != null -%}
                <a href="{{ filter.url_to_remove }}" class="collection-pills__chip">
                  {{ min | default: 0 | money }} - {{ max | default: filter.range_max | money }}
                  <span class="collection-pills__chip-remove">
                    {{- 'icon-close-small.svg' | inline_asset_content -}}
                  </span>
                </a>
              {%- endif -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- comment -%} Clear all button (when any filters active) {%- endcomment -%}
      {%- if has_any_active_filters -%}
        <a href="{{ results_url }}" class="collection-pills__clear-all">
          {{ 'products.facets.clear_all' | t | default: 'Clear all' }}
        </a>
      {%- endif -%}
    </div>
  </div>
{% endif %}
